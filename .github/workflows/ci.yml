name: CI

on: [push, pull_request]

jobs:

  build:
    runs-on: ${{ matrix.value.os }}
    strategy:
      matrix:
        value: [{ os: windows-latest, architecture: x64 }, { os: windows-latest, architecture: arm64 }, { os: ubuntu-latest, architecture: x64 }]
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive
    - uses: actions/setup-dotnet@v3
    - uses: actions/setup-node@v3
      with:
        node-version: 18
    - uses: actions/setup-go@v3
      with:
        go-version: 1.19
    - name: Build and test
      shell: pwsh
      run: ./build-and-test.ps1 -configuration Release -architecture ${{ matrix.value.architecture }}
    - name: publish artifact
      uses: actions/upload-artifact@v3
      with:
        name: ${{ env.artifact_name }}
        path: ${{ env.artifact_path }}
    - name: publish secondary artifact
      uses: actions/upload-artifact@v3
      if: env.secondary_artifact_name != ''
      with:
        name: ${{ env.secondary_artifact_name }}
        path: ${{ env.secondary_artifact_path }}

  cross_compile:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive
    - uses: devcontainers/ci@v0.3
      with:
        push: never
        runCmd: ./build-and-test.ps1 -configuration Release -architecture arm64
    - name: re-map path variables from container
      shell: pwsh
      run: |
        foreach ($name in @("artifact_path", "secondary_artifact_path")) {
          $existing = [System.Environment]::GetEnvironmentVariable($name)
          $updated = $existing.Replace("/workspaces/bcad", "${{ github.workspace }}")
          Write-Output "$name=$updated" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        }
    - name: publish artifact
      uses: actions/upload-artifact@v3
      with:
        name: ${{ env.artifact_name }}
        path: ${{ env.artifact_path }}
    - name: publish secondary artifact
      uses: actions/upload-artifact@v3
      if: env.secondary_artifact_name != ''
      with:
        name: ${{ env.secondary_artifact_name }}
        path: ${{ env.secondary_artifact_path }}
